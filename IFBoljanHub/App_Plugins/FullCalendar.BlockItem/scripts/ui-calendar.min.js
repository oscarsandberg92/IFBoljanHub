angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$timeout","$locale",function(n,t,i){var u=1,f=1,r=n.eventSources,e=n.calendarWatchEvent?n.calendarWatchEvent:angular.noop,o=function(n){var i;return n&&(i=function(){var i=arguments,r=this;t(function(){n.apply(r,i)})}),i};this.eventsFingerprint=function(n){return n._id||(n._id=f++),""+n._id+(n.id||"")+(n.title||"")+(n.url||"")+(+n.start||"")+(+n.end||"")+(n.allDay||"")+(n.className||"")+e(n)||""};this.sourcesFingerprint=function(n){return n.__id||(n.__id=u++)};this.allEvents=function(){for(var n,e,t,i,u=[],f=0,o=r.length;f<o;f++)if(n=r[f],angular.isArray(n))u.push(n);else if(angular.isObject(n)&&angular.isArray(n.events)){e={};for(t in n)t!=="_uiCalId"&&t!=="events"&&(e[t]=n[t]);for(i=0;i<n.events.length;i++)angular.extend(n.events[i],e);u.push(n.events)}return Array.prototype.concat.apply([],u)};this.changeWatcher=function(n,t){var i,f=function(){for(var e=angular.isFunction(n)?n():n,o=[],i,u,f=0,s=e.length;f<s;f++)u=e[f],i=t(u),r[i]=u,o.push(i);return o},u=function(n,t){for(var u=[],f={},i=0,r=t.length;i<r;i++)f[t[i]]=!0;for(i=0,r=n.length;i<r;i++)f[n[i]]||u.push(n[i]);return u},r={},e=function(n,f){for(var o,c,v={},y=u(f,n),s,l,a,e=0,h=y.length;e<h;e++)if(s=y[e],o=r[s],delete r[s],l=t(o),l===s)i.onRemoved(o);else{v[l]=s;i.onChanged(o)}for(a=u(n,f),e=0,h=a.length;e<h;e++)if(c=a[e],o=r[c],!v[c])i.onAdded(o)};return i={subscribe:function(n,t){n.$watch(f,function(n,i){t&&t(n,i)===!1||e(n,i)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}};this.getFullCalendarConfig=function(n,t){var i={};return angular.extend(i,t),angular.extend(i,n),angular.forEach(i,function(n,t){typeof n=="function"&&(i[t]=o(i[t]))}),i};this.getLocaleConfig=function(n){if(!n.lang||n.useNgLocale){var t=function(n){var t,i;t=[];for(i in n)t[i]=n[i];return t},r=i.DATETIME_FORMATS;return{monthNames:t(r.MONTH),monthNamesShort:t(r.SHORTMONTH),dayNames:t(r.DAY),dayNamesShort:t(r.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig","$timeout",function(n,t){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(i,r,u,f){function a(){var h=u.uiCalendar?i.$parent.$eval(u.uiCalendar):{},r,e,s,t;r=f.getFullCalendarConfig(h,n);e=f.getLocaleConfig(r);angular.extend(e,r);o={eventSources:l};angular.extend(o,e);o.calendars=null;s={};for(t in o)t!=="eventSources"&&(s[t]=o[t]);return JSON.stringify(s)}var l=i.eventSources,s=!1,e,c=f.changeWatcher(l,f.sourcesFingerprint),h=f.changeWatcher(f.allEvents,f.eventsFingerprint),o=null;i.destroy=function(){e&&e.fullCalendar&&e.fullCalendar("destroy");e=u.calendar?n.calendars[u.calendar]=$(r).html(""):$(r).html("")};i.init=function(){e.fullCalendar(o)};c.onAdded=function(n){e.fullCalendar("addEventSource",n);s=!0};c.onRemoved=function(n){e.fullCalendar("removeEventSource",n);s=!0};h.onAdded=function(n){e.fullCalendar("renderEvent",n)};h.onRemoved=function(n){e.fullCalendar("removeEvents",function(t){return t._id===n._id})};h.onChanged=function(n){n._start=$.fullCalendar.moment(n.start);n._end=$.fullCalendar.moment(n.end);e.fullCalendar("updateEvent",n)};c.subscribe(i);h.subscribe(i,function(){if(s===!0)return s=!1,!1});i.$watch(a,function(){i.destroy();t(function(){i.init()})})}}}]);